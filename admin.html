<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€ - ga100</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="logo" onclick="window.location.href='index.html'" style="cursor:pointer">ga100</h1>
                <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
                <div class="header-right">
                    <span style="color: var(--primary); font-weight: bold; margin-right: 15px;">ğŸ‘‘ ê´€ë¦¬ì</span>
                </div>
            </div>
        </div>
    </header>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>ga100</h2>
            <button class="close-sidebar" onclick="toggleSidebar()">âœ•</button>
        </div>
        <div class="sidebar-section">
            <button class="auth-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </aside>

    <main class="main-content">
        <div class="container">
            <h2 style="margin-bottom: 30px;">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>

            <div class="admin-tabs">
                <button class="admin-tab active" onclick="switchAdminTab('courses')">ê°•ì˜ ê´€ë¦¬</button>
                <button class="admin-tab" onclick="switchAdminTab('users')">íšŒì› ê´€ë¦¬</button>
                <button class="admin-tab" onclick="switchAdminTab('payments')">ê²°ì œ ìŠ¹ì¸ ê´€ë¦¬</button>
                <button class="admin-tab" onclick="switchAdminTab('stats')">í†µê³„</button>
            </div>

            <div class="admin-content active" id="courses-content">
                <div class="admin-panel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>ê°•ì˜ ëª©ë¡</h3>
                        <button class="btn btn-primary" onclick="showCourseForm()">ê°•ì˜ ì¶”ê°€</button>
                    </div>
                    <div id="coursesList"></div>
                </div>
            </div>

            <div class="admin-content" id="users-content">
                <div class="admin-panel">
                    <h3 style="margin-bottom: 20px;">íšŒì› ëª©ë¡</h3>
                    <div id="usersList"></div>
                </div>
            </div>

            <div class="admin-content" id="payments-content">
                <div class="admin-panel">
                    <h3 style="margin-bottom: 20px;">ê²°ì œ ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡</h3>
                    <div class="alert alert-info">
                        ì‚¬ìš©ìê°€ ì†¡ê¸ˆ í›„ 'í™•ì¸ ìš”ì²­'ì„ ë³´ë‚¸ ë‚´ì—­ì…ë‹ˆë‹¤. ì…ê¸ˆì´ í™•ì¸ë˜ë©´ [ìŠ¹ì¸]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                    </div>
                    <div id="paymentRequestsList"></div>
                </div>
            </div>

            <div class="admin-content" id="stats-content">
                <div class="admin-panel">
                    <h3 style="margin-bottom: 20px;">í†µê³„</h3>
                    <div id="statsContainer"></div>
                </div>
            </div>
        </div>
    </main>

    <div class="modal" id="courseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="courseModalTitle">ê°•ì˜ ì¶”ê°€</h3>
                <button class="modal-close" onclick="closeCourseModal()">âœ•</button>
            </div>
            <form onsubmit="submitCourse(event)">
                <div class="form-group">
                    <label>ê°•ì˜ ì œëª©</label>
                    <input type="text" id="courseTitle" required>
                </div>
                <div class="form-group">
                    <label>ì„¤ëª…</label>
                    <textarea id="courseDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label>ê°€ê²© (ì›, 0ì€ ë¬´ë£Œ)</label>
                    <input type="number" id="coursePrice" required min="0">
                </div>
                <div class="form-group">
                    <label>ì¹´í…Œê³ ë¦¬</label>
                    <select id="courseCategory" required>
                        <option value="ìŠ¹ì¸">ìŠ¹ì¸</option>
                        <option value="ìˆ˜ìµí™”">ìˆ˜ìµí™”</option>
                        <option value="ìµœì í™”">ìµœì í™”</option>
                        <option value="ê³ ê¸‰">ê³ ê¸‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ì´ëª¨ì§€ ì•„ì´ì½˜</label>
                    <input type="text" id="courseImage" placeholder="ğŸ“–" maxlength="2">
                </div>
                <div class="form-group">
                    <label>ë‹¤ìš´ë¡œë“œ ë§í¬ (êµ¬ê¸€ ë“œë¼ì´ë¸Œ/PDF URL)</label>
                    <input type="url" id="courseDownloadUrl" placeholder="https://..." required>
                    <small style="color:var(--gray)">ê²°ì œ ì™„ë£Œëœ ì‚¬ìš©ìì—ê²Œë§Œ ë³´ì´ëŠ” ë²„íŠ¼ì˜ ë§í¬ì…ë‹ˆë‹¤.</small>
                </div>
                <div class="form-group">
                    <label>ê²°ì œ/ì†¡ê¸ˆ ì•ˆë‚´ (ì€í–‰ ê³„ì¢Œ ë˜ëŠ” í† ìŠ¤ ë§í¬)</label>
                    <input type="text" id="coursePaymentInfo" placeholder="ì˜ˆ: ì¹´ì¹´ì˜¤ë±…í¬ 3333-xx-xxxx í™ê¸¸ë™" required>
                    <small style="color:var(--gray)">ì‚¬ìš©ìê°€ êµ¬ë§¤ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ë³´ì—¬ì§ˆ ë¬¸êµ¬ì…ë‹ˆë‹¤.</small>
                </div>
                
                <div class="form-group">
                    <label>ê°•ì˜ ìƒì„¸ ë‚´ìš© (HTML ì§€ì›)</label>
                    <textarea id="courseContent" required style="min-height: 200px;"></textarea>
                </div>
                <input type="hidden" id="courseId">
                <button type="submit" class="btn btn-primary">ì €ì¥</button>
            </form>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p class="copyright">Â© 2024 ga100. All rights reserved.</p>
        </div>
    </footer>

    <script>
        let currentUser = JSON.parse(localStorage.getItem('currentUser'));

        if (!currentUser || currentUser.role !== 'admin') {
            alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'index.html';
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + '-content').classList.add('active');
            
            if (tab === 'courses') loadCourses();
            if (tab === 'users') loadUsers();
            if (tab === 'payments') loadPaymentRequests();
            if (tab === 'stats') loadStats();
        }

        function loadCourses() {
            const courses = JSON.parse(localStorage.getItem('courses') || '[]');
            const list = document.getElementById('coursesList');

            if (courses.length === 0) {
                list.innerHTML = '<p style="color: var(--gray); padding: 20px;">ë“±ë¡ëœ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            list.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ì œëª©</th>
                            <th>ê°€ê²©</th>
                            <th>ë“±ë¡ì¼</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${courses.map(course => `
                            <tr>
                                <td>${course.image} ${course.title}</td>
                                <td>${course.price === 0 ? 'ë¬´ë£Œ' : course.price.toLocaleString() + 'ì›'}</td>
                                <td>${new Date(course.createdAt).toLocaleDateString('ko-KR')}</td>
                                <td>
                                    <button class="btn btn-primary" style="padding: 6px 12px; font-size: 14px; margin-right: 5px;" onclick="editCourse(${course.id})">ìˆ˜ì •</button>
                                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px; background: var(--danger);" onclick="deleteCourse(${course.id})">ì‚­ì œ</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // --- Payment Request Logic (New) ---
        function loadPaymentRequests() {
            const requests = JSON.parse(localStorage.getItem('paymentRequests') || '[]');
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const courses = JSON.parse(localStorage.getItem('courses') || '[]');
            
            const list = document.getElementById('paymentRequestsList');

            if (requests.length === 0) {
                list.innerHTML = '<p style="color: var(--gray); padding: 20px;">ëŒ€ê¸° ì¤‘ì¸ ê²°ì œ ìŠ¹ì¸ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            list.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ì‹ ì²­ì</th>
                            <th>ê°•ì˜ëª…</th>
                            <th>ì…ê¸ˆìëª…</th>
                            <th>ì‹ ì²­ì¼ì‹œ</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${requests.map(req => {
                            const course = courses.find(c => c.id === req.courseId);
                            const courseTitle = course ? course.title : 'ì‚­ì œëœ ê°•ì˜';
                            return `
                                <tr>
                                    <td>${req.nickname}</td>
                                    <td>${courseTitle}</td>
                                    <td><strong>${req.depositor}</strong></td>
                                    <td>${new Date(req.createdAt).toLocaleString('ko-KR')}</td>
                                    <td>
                                        <button class="btn btn-primary" style="padding: 6px 12px; background: var(--success);" onclick="approvePayment(${req.id})">ìŠ¹ì¸</button>
                                        <button class="btn btn-secondary" style="padding: 6px 12px; background: var(--danger);" onclick="rejectPayment(${req.id})">ê±°ì ˆ</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function approvePayment(requestId) {
            const requests = JSON.parse(localStorage.getItem('paymentRequests') || '[]');
            const reqIndex = requests.findIndex(r => r.id === requestId);
            
            if (reqIndex === -1) return;
            const req = requests[reqIndex];

            if(!confirm(`'${req.depositor}'ë‹˜ì˜ ì…ê¸ˆì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆê¹Œ? ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            // 1. Add course to user
            let users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.nickname === req.nickname);
            
            if (userIndex !== -1 && !users[userIndex].courses.includes(req.courseId)) {
                users[userIndex].courses.push(req.courseId);
                
                // Add points (Bonus logic)
                users[userIndex].points = (users[userIndex].points || 0) + 1000;
                
                localStorage.setItem('users', JSON.stringify(users));
            }

            // 2. Remove request
            requests.splice(reqIndex, 1);
            localStorage.setItem('paymentRequests', JSON.stringify(requests));

            // 3. Create notification (Optional but good)
            let notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            notifications.unshift({
                id: Date.now(),
                message: `[ìŠ¹ì¸ ì™„ë£Œ] ì‹ ì²­í•˜ì‹  ê°•ì˜ ìˆ˜ê°•ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`,
                link: `course-detail.html?id=${req.courseId}`,
                read: false,
                time: new Date().toISOString()
            });
            localStorage.setItem('notifications', JSON.stringify(notifications));

            alert('ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ìš©ìëŠ” ì´ì œ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            loadPaymentRequests();
        }

        function rejectPayment(requestId) {
            if(!confirm('ì •ë§ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ìš”ì²­ ë‚´ì—­ì´ ì‚­ì œë©ë‹ˆë‹¤.')) return;
            
            let requests = JSON.parse(localStorage.getItem('paymentRequests') || '[]');
            requests = requests.filter(r => r.id !== requestId);
            localStorage.setItem('paymentRequests', JSON.stringify(requests));
            
            alert('ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadPaymentRequests();
        }

        // --- Course Form Logic ---
        function showCourseForm(courseId = null) {
            const modal = document.getElementById('courseModal');
            const title = document.getElementById('courseModalTitle');
            
            if (courseId) {
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const course = courses.find(c => c.id === courseId);
                
                if (course) {
                    title.textContent = 'ê°•ì˜ ìˆ˜ì •';
                    document.getElementById('courseId').value = course.id;
                    document.getElementById('courseTitle').value = course.title;
                    document.getElementById('courseDescription').value = course.description;
                    document.getElementById('coursePrice').value = course.price;
                    document.getElementById('courseCategory').value = course.category;
                    document.getElementById('courseImage').value = course.image;
                    document.getElementById('courseContent').value = course.content;
                    document.getElementById('courseDownloadUrl').value = course.downloadUrl || '';
                    document.getElementById('coursePaymentInfo').value = course.paymentInfo || '';
                }
            } else {
                title.textContent = 'ê°•ì˜ ì¶”ê°€';
                document.getElementById('courseId').value = '';
                document.getElementById('courseTitle').value = '';
                document.getElementById('courseDescription').value = '';
                document.getElementById('coursePrice').value = '';
                document.getElementById('courseCategory').value = 'ìŠ¹ì¸';
                document.getElementById('courseImage').value = 'ğŸ“–';
                document.getElementById('courseContent').value = '';
                document.getElementById('courseDownloadUrl').value = '';
                document.getElementById('coursePaymentInfo').value = '';
            }
            
            modal.classList.add('active');
        }

        function editCourse(id) {
            showCourseForm(id);
        }

        function closeCourseModal() {
            document.getElementById('courseModal').classList.remove('active');
        }

        function submitCourse(e) {
            e.preventDefault();
            
            let courses = JSON.parse(localStorage.getItem('courses') || '[]');
            const courseId = document.getElementById('courseId').value;
            
            const courseData = {
                title: document.getElementById('courseTitle').value.trim(),
                description: document.getElementById('courseDescription').value.trim(),
                price: parseInt(document.getElementById('coursePrice').value),
                category: document.getElementById('courseCategory').value,
                image: document.getElementById('courseImage').value.trim() || 'ğŸ“–',
                content: document.getElementById('courseContent').value.trim(),
                downloadUrl: document.getElementById('courseDownloadUrl').value.trim(),
                paymentInfo: document.getElementById('coursePaymentInfo').value.trim()
            };

            if (courseId) {
                const index = courses.findIndex(c => c.id === parseInt(courseId));
                courses[index] = { ...courses[index], ...courseData };
            } else {
                courses.push({
                    id: Date.now(),
                    ...courseData,
                    createdAt: new Date().toISOString()
                });
            }

            localStorage.setItem('courses', JSON.stringify(courses));
            alert('ê°•ì˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            closeCourseModal();
            loadCourses();
        }

        function deleteCourse(id) {
            if (!confirm('ì •ë§ ì´ ê°•ì˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            let courses = JSON.parse(localStorage.getItem('courses') || '[]');
            courses = courses.filter(c => c.id !== id);
            localStorage.setItem('courses', JSON.stringify(courses));
            alert('ê°•ì˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadCourses();
        }

        function loadUsers() {
            // Existing logic remains same...
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const regularUsers = users.filter(u => u.role !== 'admin');
            const list = document.getElementById('usersList');
            if (regularUsers.length === 0) {
                list.innerHTML = '<p style="color: var(--gray); padding: 20px;">íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            list.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ë‹‰ë„¤ì„</th>
                            <th>í¬ì¸íŠ¸</th>
                            <th>ìˆ˜ê°• ê°•ì˜</th>
                            <th>ê°€ì…ì¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${regularUsers.map(user => `
                            <tr>
                                <td>${user.nickname}</td>
                                <td>${(user.points || 0).toLocaleString()} P</td>
                                <td>${(user.courses || []).length}ê°œ</td>
                                <td>${new Date(user.createdAt).toLocaleDateString('ko-KR')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function loadStats() {
            // Existing logic...
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const courses = JSON.parse(localStorage.getItem('courses') || '[]');
            const requests = JSON.parse(localStorage.getItem('paymentRequests') || '[]');
            
            const stats = document.getElementById('statsContainer');
            stats.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="background: var(--light-gray); padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 36px; font-weight: bold; color: var(--primary); margin-bottom: 5px;">${users.length}</div>
                        <div style="color: var(--gray);">ì´ íšŒì›</div>
                    </div>
                    <div style="background: var(--light-gray); padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 36px; font-weight: bold; color: var(--primary); margin-bottom: 5px;">${courses.length}</div>
                        <div style="color: var(--gray);">ì´ ê°•ì˜</div>
                    </div>
                    <div style="background: var(--light-gray); padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 36px; font-weight: bold; color: var(--warning); margin-bottom: 5px;">${requests.length}</div>
                        <div style="color: var(--gray);">ìŠ¹ì¸ ëŒ€ê¸°</div>
                    </div>
                </div>
            `;
        }

        loadCourses();
    </script>
</body>
</html>
