<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€ - ga100</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="logo" onclick="window.location.href='index.html'" style="cursor:pointer">ga100</h1>
                <div class="header-right">
                    <span style="color: var(--primary); font-weight: bold; margin-right: 15px;">ğŸ‘‘ ê´€ë¦¬ì ëª¨ë“œ</span>
                    <button class="auth-btn" onclick="logout()" style="width: auto; padding: 8px 16px;">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="admin-panel" style="background: linear-gradient(135deg, #4f46e5 0%, #06b6d4 100%); color: white; margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin-bottom: 5px; color: rgba(255,255,255,0.9);">ì˜¤ëŠ˜ì˜ ë§¤ì¶œ</h3>
                        <p style="font-size: 14px; opacity: 0.8;">ìŠ¹ì¸ ì™„ë£Œëœ ê°•ì˜ íŒë§¤ ê¸ˆì•¡ í•©ê³„</p>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 36px; font-weight: bold;" id="dailyRevenueDisplay">0ì›</div>
                        <div style="font-size: 14px;" id="totalRevenueDisplay">ëˆ„ì  ë§¤ì¶œ: 0ì›</div>
                    </div>
                </div>
            </div>

            <div class="admin-tabs">
                <button class="admin-tab active" onclick="switchAdminTab('courses')">ê°•ì˜ ê´€ë¦¬</button>
                <button class="admin-tab" onclick="switchAdminTab('users')">íšŒì› ê´€ë¦¬ (ì²˜ë¶„)</button>
                <button class="admin-tab" onclick="switchAdminTab('payments')">ê²°ì œ ìŠ¹ì¸ ê´€ë¦¬</button>
            </div>

            <div class="admin-content active" id="courses-content">
                <div class="admin-panel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>ê°•ì˜ ëª©ë¡</h3>
                        <button class="btn btn-primary" onclick="showCourseForm()">+ ê°•ì˜ ì¶”ê°€</button>
                    </div>
                    <div id="coursesList"></div>
                </div>
            </div>

            <div class="admin-content" id="users-content">
                <div class="admin-panel">
                    <h3 style="margin-bottom: 20px;">íšŒì› ê´€ë¦¬ ë° ì²˜ë¶„</h3>
                    <div class="alert alert-info">
                        â›” <strong>ì •ì§€/ì°¨ë‹¨</strong> ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í•´ë‹¹ íšŒì›ì€ ì¦‰ì‹œ ë¡œê·¸ì¸ì´ ë¶ˆê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.
                    </div>
                    <div id="usersList"></div>
                </div>
            </div>

            <div class="admin-content" id="payments-content">
                <div class="admin-panel">
                    <h3 style="margin-bottom: 20px;">ê²°ì œ ìŠ¹ì¸ ëŒ€ê¸°</h3>
                    <div id="paymentRequestsList"></div>
                </div>
            </div>
        </div>
    </main>

    <div class="modal" id="courseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="courseModalTitle">ê°•ì˜ ì¶”ê°€</h3>
                <button class="modal-close" onclick="closeCourseModal()">âœ•</button>
            </div>
            <form onsubmit="submitCourse(event)">
                <div class="form-group">
                    <label>ê°•ì˜ ì œëª©</label>
                    <input type="text" id="courseTitle" required>
                </div>
                <div class="form-group">
                    <label>ì„¤ëª…</label>
                    <textarea id="courseDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label>ê°€ê²© (ì›)</label>
                    <input type="number" id="coursePrice" required min="0">
                </div>
                <div class="form-group">
                    <label>ì¹´í…Œê³ ë¦¬</label>
                    <select id="courseCategory">
                        <option value="ìŠ¹ì¸">ìŠ¹ì¸</option>
                        <option value="ìˆ˜ìµí™”">ìˆ˜ìµí™”</option>
                        <option value="ìµœì í™”">ìµœì í™”</option>
                        <option value="ê³ ê¸‰">ê³ ê¸‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ì´ëª¨ì§€</label>
                    <input type="text" id="courseImage" placeholder="ğŸ“–">
                </div>
                <div class="form-group">
                    <label>ë‹¤ìš´ë¡œë“œ ë§í¬</label>
                    <input type="text" id="courseDownloadUrl" placeholder="URL ì…ë ¥">
                </div>
                <div class="form-group">
                    <label>ê²°ì œ ì•ˆë‚´ ë¬¸êµ¬</label>
                    <input type="text" id="coursePaymentInfo" placeholder="ê³„ì¢Œë²ˆí˜¸ ë“±">
                </div>
                <div class="form-group">
                    <label>ìƒì„¸ ë‚´ìš©</label>
                    <textarea id="courseContent" style="min-height: 150px;"></textarea>
                </div>
                <input type="hidden" id="courseId">
                <button type="submit" class="btn btn-primary">ì €ì¥</button>
            </form>
        </div>
    </div>

    <script>
        let currentUser = JSON.parse(localStorage.getItem('currentUser'));

        // ê´€ë¦¬ì ì²´í¬
        if (!currentUser || currentUser.role !== 'admin') {
            alert('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            window.location.href = 'index.html';
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + '-content').classList.add('active');
            
            if (tab === 'courses') loadCourses();
            if (tab === 'users') loadUsers();
            if (tab === 'payments') loadPaymentRequests();
            
            // íƒ­ ì „í™˜ ì‹œ ë§¤ì¶œë„ í•­ìƒ ìµœì‹ í™”
            calculateRevenue();
        }

        // --- 1. ë§¤ì¶œ ê´€ë¦¬ ë¡œì§ (ì‹ ê·œ) ---
        function calculateRevenue() {
            const history = JSON.parse(localStorage.getItem('revenueHistory') || '[]');
            
            // ì˜¤ëŠ˜ ë‚ ì§œ êµ¬í•˜ê¸° (YYYY-MM-DD)
            const today = new Date().toISOString().split('T')[0];
            
            // ì¼ì¼ ë§¤ì¶œ ê³„ì‚°
            const dailyTotal = history
                .filter(item => item.date.startsWith(today))
                .reduce((sum, item) => sum + item.amount, 0);

            // ëˆ„ì  ë§¤ì¶œ ê³„ì‚°
            const totalRevenue = history.reduce((sum, item) => sum + item.amount, 0);

            document.getElementById('dailyRevenueDisplay').textContent = dailyTotal.toLocaleString() + 'ì›';
            document.getElementById('totalRevenueDisplay').textContent = 'ëˆ„ì  ë§¤ì¶œ: ' + totalRevenue.toLocaleString() + 'ì›';
        }

        // --- 2. ê°•ì˜ ê´€ë¦¬ ë¡œì§ (ìˆ˜ì •ë¨: ì‚­ì œ ë²„ê·¸ í•´ê²°) ---
        function loadCourses() {
            const courses = JSON.parse(localStorage.getItem('courses') || '[]');
            const list = document.getElementById('coursesList');

            if (courses.length === 0) {
                list.innerHTML = '<p style="padding: 20px; text-align: center; color: var(--gray);">ë“±ë¡ëœ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            list.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ì œëª©</th>
                            <th>ê°€ê²©</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${courses.map(course => `
                            <tr>
                                <td>${course.image} ${course.title}</td>
                                <td>${course.price.toLocaleString()}ì›</td>
                                <td>
                                    <button class="btn" style="background:var(--primary); color:white; padding:5px 10px; font-size:14px;" onclick="editCourse(${course.id})">ìˆ˜ì •</button>
                                    <button class="btn" style="background:var(--danger); color:white; padding:5px 10px; font-size:14px;" onclick="deleteCourse(${course.id})">ì‚­ì œ</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function deleteCourse(id) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            let courses = JSON.parse(localStorage.getItem('courses') || '[]');
            const newCourses = courses.filter(c => c.id !== id);
            
            // ì¤‘ìš”: ë¹ˆ ë°°ì—´ì´ë¼ë„ ì €ì¥í•´ì•¼ í•¨ (ì´ˆê¸°í™” ë°©ì§€)
            localStorage.setItem('courses', JSON.stringify(newCourses));
            
            loadCourses();
        }

        function showCourseForm(courseId = null) {
            const modal = document.getElementById('courseModal');
            document.getElementById('courseId').value = courseId || '';
            
            if (courseId) {
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                const c = courses.find(x => x.id === courseId);
                if(c) {
                    document.getElementById('courseTitle').value = c.title;
                    document.getElementById('courseDescription').value = c.description;
                    document.getElementById('coursePrice').value = c.price;
                    document.getElementById('courseCategory').value = c.category;
                    document.getElementById('courseImage').value = c.image;
                    document.getElementById('courseDownloadUrl').value = c.downloadUrl || '';
                    document.getElementById('coursePaymentInfo').value = c.paymentInfo || '';
                    document.getElementById('courseContent').value = c.content || '';
                }
            } else {
                // í¼ ì´ˆê¸°í™”
                document.getElementById('courseTitle').value = '';
                document.getElementById('courseDescription').value = '';
                document.getElementById('coursePrice').value = '';
                document.getElementById('courseDownloadUrl').value = '';
                document.getElementById('coursePaymentInfo').value = '';
                document.getElementById('courseContent').value = '';
            }
            modal.classList.add('active');
        }

        function closeCourseModal() {
            document.getElementById('courseModal').classList.remove('active');
        }

        function submitCourse(e) {
            e.preventDefault();
            const idVal = document.getElementById('courseId').value;
            const newCourse = {
                id: idVal ? parseInt(idVal) : Date.now(),
                title: document.getElementById('courseTitle').value,
                description: document.getElementById('courseDescription').value,
                price: parseInt(document.getElementById('coursePrice').value),
                category: document.getElementById('courseCategory').value,
                image: document.getElementById('courseImage').value || 'ğŸ“–',
                downloadUrl: document.getElementById('courseDownloadUrl').value,
                paymentInfo: document.getElementById('coursePaymentInfo').value,
                content: document.getElementById('courseContent').value,
                createdAt: new Date().toISOString()
            };

            let courses = JSON.parse(localStorage.getItem('courses') || '[]');
            
            if (idVal) {
                const idx = courses.findIndex(c => c.id === parseInt(idVal));
                if (idx > -1) courses[idx] = newCourse;
            } else {
                courses.push(newCourse);
            }

            localStorage.setItem('courses', JSON.stringify(courses));
            closeCourseModal();
            loadCourses();
        }

        // --- 3. íšŒì› ê´€ë¦¬ (ì •ì§€/ì°¨ë‹¨) ---
        function loadUsers() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const list = document.getElementById('usersList');
            // ê´€ë¦¬ì ì œì™¸ ëª©ë¡
            const regularUsers = users.filter(u => u.role !== 'admin');

            list.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ìƒíƒœ</th>
                            <th>ë‹‰ë„¤ì„</th>
                            <th>í¬ì¸íŠ¸</th>
                            <th>ê°€ì…ì¼</th>
                            <th>ê´€ë¦¬ (ì²˜ë¶„)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${regularUsers.map(user => {
                            const isBanned = user.status === 'banned';
                            return `
                            <tr style="${isBanned ? 'background-color: #fee2e2;' : ''}">
                                <td>${isBanned ? 'ğŸ”´ ì •ì§€ë¨' : 'ğŸŸ¢ í™œë™ì¤‘'}</td>
                                <td>${user.nickname}</td>
                                <td>${(user.points || 0).toLocaleString()}</td>
                                <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                                <td>
                                    ${isBanned 
                                        ? `<button class="btn" style="background:var(--gray); font-size:12px; padding:6px;" onclick="setBan('${user.nickname}', false)">ì°¨ë‹¨ í•´ì œ</button>` 
                                        : `<button class="btn" style="background:var(--danger); color:white; font-size:12px; padding:6px;" onclick="setBan('${user.nickname}', true)">â›” ì •ì§€/ì°¨ë‹¨</button>`
                                    }
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;
        }

        function setBan(nickname, ban) {
            if (ban && !confirm(`'${nickname}' íšŒì›ì„ ê°•ì œë¡œ ì •ì§€ì‹œí‚¤ê² ìŠµë‹ˆê¹Œ?\nì´ íšŒì›ì€ ë” ì´ìƒ ë¡œê·¸ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
            
            let users = JSON.parse(localStorage.getItem('users') || '[]');
            const idx = users.findIndex(u => u.nickname === nickname);
            
            if (idx > -1) {
                users[idx].status = ban ? 'banned' : 'active';
                localStorage.setItem('users', JSON.stringify(users));
                loadUsers();
                alert(ban ? 'íšŒì›ì„ ì •ì§€ì‹œì¼°ìŠµë‹ˆë‹¤.' : 'ì •ì§€ë¥¼ í•´ì œí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // --- 4. ê²°ì œ ìŠ¹ì¸ ë° ë§¤ì¶œ ê¸°ë¡ ---
        function loadPaymentRequests() {
            const requests = JSON.parse(localStorage.getItem('paymentRequests') || '[]');
            const courses = JSON.parse(localStorage.getItem('courses') || '[]');
            const list = document.getElementById('paymentRequestsList');

            if (requests.length === 0) {
                list.innerHTML = '<p style="padding:20px; color:gray;">ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            list.innerHTML = requests.map(req => {
                const course = courses.find(c => c.id === req.courseId);
                const title = course ? course.title : '(ì‚­ì œëœ ê°•ì˜)';
                const price = course ? course.price : 0;
                
                return `
                <div class="admin-panel" style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>${title}</strong> (${price.toLocaleString()}ì›)<br>
                        <span style="font-size:14px; color:gray;">ì‹ ì²­ì: ${req.nickname} / ì…ê¸ˆì: ${req.depositor}</span>
                    </div>
                    <div>
                        <button class="btn" style="background:var(--success); color:white; margin-right:5px;" onclick="approvePayment(${req.id}, ${price})">ìŠ¹ì¸</button>
                        <button class="btn" style="background:var(--danger); color:white;" onclick="rejectPayment(${req.id})">ê±°ì ˆ</button>
                    </div>
                </div>
            `}).join('');
        }

        function approvePayment(reqId, amount) {
            if(!confirm('ì…ê¸ˆì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆê¹Œ? ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            let requests = JSON.parse(localStorage.getItem('paymentRequests') || '[]');
            const req = requests.find(r => r.id === reqId);
            if (!req) return;

            // 1. ìœ ì €ì—ê²Œ ê°•ì˜ ì¶”ê°€
            let users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIdx = users.findIndex(u => u.nickname === req.nickname);
            if (userIdx > -1) {
                if (!users[userIdx].courses) users[userIdx].courses = [];
                if (!users[userIdx].courses.includes(req.courseId)) {
                    users[userIdx].courses.push(req.courseId);
                    localStorage.setItem('users', JSON.stringify(users));
                }
            }

            // 2. ë§¤ì¶œ ê¸°ë¡ ì €ì¥ (ì¼ì¼ ë§¤ì¶œìš©)
            let history = JSON.parse(localStorage.getItem('revenueHistory') || '[]');
            history.push({
                date: new Date().toISOString(), // ë‚ ì§œ ë° ì‹œê°„ í¬í•¨
                amount: amount,
                courseId: req.courseId,
                payer: req.nickname
            });
            localStorage.setItem('revenueHistory', JSON.stringify(history));

            // 3. ìš”ì²­ ì‚­ì œ
            const newRequests = requests.filter(r => r.id !== reqId);
            localStorage.setItem('paymentRequests', JSON.stringify(newRequests));

            alert('ìŠ¹ì¸ ì™„ë£Œ! ë§¤ì¶œì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadPaymentRequests();
            calculateRevenue(); // ë§¤ì¶œ ê°±ì‹ 
        }

        function rejectPayment(reqId) {
            if(!confirm('ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            let requests = JSON.parse(localStorage.getItem('paymentRequests') || '[]');
            const newRequests = requests.filter(r => r.id !== reqId);
            localStorage.setItem('paymentRequests', JSON.stringify(newRequests));
            loadPaymentRequests();
        }

        // ì´ˆê¸° ì‹¤í–‰
        loadCourses();
        calculateRevenue();

    </script>
</body>
</html>
