<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€ - ga100</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="logo" onclick="window.location.href='index.html'" style="cursor:pointer">ga100</h1>
                <div class="header-right">
                    <span style="color: var(--primary); font-weight: bold; margin-right: 15px;">ğŸ‘‘ ê´€ë¦¬ì ëª¨ë“œ</span>
                </div>
            </div>
        </div>
    </header>

    <div style="display: flex; min-height: calc(100vh - 70px);">
        <aside style="width: 250px; background: var(--white); border-right: 1px solid var(--border); padding: 20px;">
            <div style="margin-bottom: 20px;">
                <button class="auth-btn" onclick="handleLogout()" style="background: var(--gray);">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <nav class="admin-nav">
                <button class="admin-tab active" onclick="switchAdminTab('stats')">ğŸ“Š ëŒ€ì‹œë³´ë“œ/í†µê³„</button>
                <button class="admin-tab" onclick="switchAdminTab('users')">ğŸ‘¥ íšŒì› ê´€ë¦¬</button>
                <button class="admin-tab" onclick="switchAdminTab('courses')">ğŸ“š ê°•ì˜ ê´€ë¦¬</button>
                <button class="admin-tab" onclick="switchAdminTab('payments')">ğŸ’° ê²°ì œ/ë§¤ì¶œ ê´€ë¦¬</button>
            </nav>
        </aside>

        <main style="flex: 1; padding: 30px; background: var(--light-gray); overflow-y: auto;">
            
            <div class="admin-content active" id="stats-content">
                <h2 style="margin-bottom: 20px;">ëŒ€ì‹œë³´ë“œ</h2>
                <div id="statsContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="text-align:center; padding: 40px;">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                </div>
            </div>

            <div class="admin-content" id="users-content">
                <div class="admin-panel">
                    <h3 style="margin-bottom: 20px;">íšŒì› ê´€ë¦¬</h3>
                    <div style="margin-bottom: 15px; display:flex; gap:10px;">
                        <input type="text" id="userSearch" placeholder="ë‹‰ë„¤ì„ ë˜ëŠ” ì´ë©”ì¼ ê²€ìƒ‰" style="padding: 8px; border:1px solid var(--border); border-radius:4px; width: 300px;">
                        <button class="btn btn-primary" onclick="loadUsers()">ê²€ìƒ‰</button>
                    </div>
                    <div id="usersList" style="overflow-x: auto;"></div>
                </div>
            </div>

            <div class="admin-content" id="courses-content">
                <div class="admin-panel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>ê°•ì˜ ëª©ë¡</h3>
                        <button class="btn btn-primary" onclick="showCourseForm()">+ ê°•ì˜ ì¶”ê°€</button>
                    </div>
                    <div id="coursesList"></div>
                </div>
            </div>
            
            <div class="admin-content" id="payments-content">
                <div class="admin-panel">
                    <h3 style="margin-bottom: 20px;">ë§¤ì¶œ/ê²°ì œ ê´€ë¦¬</h3>
                    <p class="alert alert-info">ì‹¤ì œ ê²°ì œ ì‹œìŠ¤í…œ ì—°ë™ ì „ì…ë‹ˆë‹¤. ìˆ˜ë™ ìŠ¹ì¸ ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.</p>
                    <div id="paymentsList">ê¸°ëŠ¥ ì¤€ë¹„ì¤‘...</div>
                </div>
            </div>

        </main>
    </div>

    <div class="modal" id="courseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="courseModalTitle">ê°•ì˜ ê´€ë¦¬</h3>
                <button class="modal-close" onclick="closeCourseModal()">âœ•</button>
            </div>
            <form id="courseForm">
                <input type="hidden" id="courseId">
                <div class="form-group">
                    <label>ì œëª©</label>
                    <input type="text" id="courseTitle" required>
                </div>
                <div class="form-group">
                    <label>ì„¤ëª…</label>
                    <textarea id="courseDescription" required style="height: 60px;"></textarea>
                </div>
                <div class="form-group">
                    <label>ê°€ê²© (ì›)</label>
                    <input type="number" id="coursePrice" required min="0">
                </div>
                <div class="form-group">
                    <label>ì¹´í…Œê³ ë¦¬</label>
                    <select id="courseCategory">
                        <option value="ìŠ¹ì¸">ìŠ¹ì¸</option>
                        <option value="ìˆ˜ìµí™”">ìˆ˜ìµí™”</option>
                        <option value="ìµœì í™”">ìµœì í™”</option>
                        <option value="ê³ ê¸‰">ê³ ê¸‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ì´ëª¨ì§€</label>
                    <input type="text" id="courseImage" placeholder="ğŸ“–" maxlength="2">
                </div>
                 <div class="form-group">
                    <label>ë³¸ë¬¸ ë‚´ìš© (HTML ê°€ëŠ¥)</label>
                    <textarea id="courseContent" required style="height: 200px;"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">ì €ì¥í•˜ê¸°</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './firebase-init.js';
        import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            collection, getDocs, doc, getDoc, addDoc, updateDoc, deleteDoc, query, orderBy, where 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let currentAdmin = null;

        // ì¸ì¦ ì²´í¬ ë° ì´ˆê¸°í™”
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                const userData = userDoc.data();
                if (userData && userData.role === 'admin') {
                    currentAdmin = userData;
                    initAdmin();
                } else {
                    alert('ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                    window.location.href = 'index.html';
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        window.handleLogout = () => {
            signOut(auth).then(() => window.location.href = 'login.html');
        };

        window.switchAdminTab = (tab) => {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-content').forEach(c => c.classList.remove('active'));
            
            // ë²„íŠ¼ í™œì„±í™”
            const activeBtn = Array.from(document.querySelectorAll('.admin-tab')).find(b => b.textContent.includes(
                tab === 'stats' ? 'ëŒ€ì‹œë³´ë“œ' : 
                tab === 'users' ? 'íšŒì›' : 
                tab === 'courses' ? 'ê°•ì˜' : 'ê²°ì œ'
            ));
            if(activeBtn) activeBtn.classList.add('active');

            document.getElementById(tab + '-content').classList.add('active');
            
            if (tab === 'stats') loadStats();
            if (tab === 'users') loadUsers();
            if (tab === 'courses') loadCourses();
        };

        function initAdmin() {
            loadStats();
        }

        // --- 1. í†µê³„/ëŒ€ì‹œë³´ë“œ ---
        async function loadStats() {
            try {
                const usersSnap = await getCount(collection(db, "users"));
                const coursesSnap = await getCount(collection(db, "courses"));
                // Firestore v9 countëŠ” ì„œë²„ ì‚¬ì´ë“œ ì§‘ê³„ ì¿¼ë¦¬ë¥¼ ì“°ê±°ë‚˜, ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ì½ì–´ì„œ ê¸¸ì´ ì¸¡ì • (ë¬¸ì„œê°€ ë§ìœ¼ë©´ ë¹„íš¨ìœ¨ì ì¼ ìˆ˜ ìˆìŒ)
                // ë°ëª¨ìš©ìœ¼ë¡œ length ì²´í¬
                const usersQuery = await getDocs(collection(db, "users"));
                const coursesQuery = await getDocs(collection(db, "courses"));
                
                const statsHTML = `
                    <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <div style="font-size: 36px; font-weight: bold; color: var(--primary);">${usersQuery.size}</div>
                        <div style="color: var(--gray);">ì´ íšŒì› ìˆ˜</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <div style="font-size: 36px; font-weight: bold; color: var(--success);">${coursesQuery.size}</div>
                        <div style="color: var(--gray);">ë“±ë¡ëœ ê°•ì˜</div>
                    </div>
                    `;
                document.getElementById('statsContainer').innerHTML = statsHTML;
            } catch (e) {
                console.error("Stats error", e);
            }
        }
        
        // Helper since count() is server aggregation feature
        async function getCount(colRef) {
           const snap = await getDocs(colRef);
           return snap.size;
        }

        // --- 2. íšŒì› ê´€ë¦¬ ---
        window.loadUsers = async () => {
            const list = document.getElementById('usersList');
            list.innerHTML = 'ë¡œë”© ì¤‘...';
            
            try {
                const q = query(collection(db, "users"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                let html = `
                    <table class="table" style="min-width: 800px;">
                        <thead>
                            <tr>
                                <th>ê°€ì…ì¼</th>
                                <th>ë‹‰ë„¤ì„ (Email)</th>
                                <th>í¬ì¸íŠ¸</th>
                                <th>ìƒíƒœ</th>
                                <th>ê´€ë¦¬ ì‘ì—…</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                querySnapshot.forEach((doc) => {
                    const u = doc.data();
                    const isSuspended = u.suspended && new Date(u.suspendedUntil) > new Date();
                    
                    html += `
                        <tr style="background: ${u.blacklisted ? '#fee2e2' : 'white'}">
                            <td>${new Date(u.createdAt).toLocaleDateString()}</td>
                            <td>
                                <strong>${u.nickname}</strong><br>
                                <span style="font-size:12px; color:gray">${u.email}</span>
                            </td>
                            <td>${(u.points || 0).toLocaleString()} P</td>
                            <td>
                                ${u.role === 'admin' ? '<span class="badge badge-success">ê´€ë¦¬ì</span>' : ''}
                                ${isSuspended ? '<span class="badge badge-warning">ì •ì§€ë¨</span>' : ''}
                                ${u.blacklisted ? '<span class="badge badge-danger">ë¸”ë™ë¦¬ìŠ¤íŠ¸</span>' : ''}
                                ${!isSuspended && !u.blacklisted && u.role !== 'admin' ? '<span class="badge badge-success">ì •ìƒ</span>' : ''}
                            </td>
                            <td>
                                ${u.role !== 'admin' ? `
                                    <button class="btn" style="padding:4px 8px; font-size:12px; background:var(--warning); color:white" onclick="toggleSuspend('${u.uid}', ${isSuspended})">
                                        ${isSuspended ? 'ì •ì§€ í•´ì œ' : '30ì¼ ì •ì§€'}
                                    </button>
                                    <button class="btn" style="padding:4px 8px; font-size:12px; background:var(--danger); color:white" onclick="toggleBlacklist('${u.uid}', ${u.blacklisted})">
                                        ${u.blacklisted ? 'ë¸”ë™ í•´ì œ' : 'ë¸”ë™ë¦¬ìŠ¤íŠ¸'}
                                    </button>
                                    <button class="btn" style="padding:4px 8px; font-size:12px; background:var(--primary); color:white" onclick="editPoints('${u.uid}', ${u.points})">
                                        í¬ì¸íŠ¸ ìˆ˜ì •
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                list.innerHTML = html;
            } catch (e) {
                list.innerHTML = 'íšŒì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ' + e.message;
            }
        };

        window.toggleSuspend = async (uid, isCurrentlySuspended) => {
            if(!confirm(isCurrentlySuspended ? 'ì •ì§€ë¥¼ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'ì´ íšŒì›ì„ 30ì¼ê°„ ì •ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const userRef = doc(db, "users", uid);
                if (isCurrentlySuspended) {
                    await updateDoc(userRef, { suspended: false, suspendedUntil: null });
                } else {
                    const date = new Date();
                    date.setDate(date.getDate() + 30);
                    await updateDoc(userRef, { suspended: true, suspendedUntil: date.toISOString() });
                }
                loadUsers();
            } catch(e) { alert(e.message); }
        };

        window.toggleBlacklist = async (uid, isBlacklisted) => {
            if(!confirm(isBlacklisted ? 'ë¸”ë™ë¦¬ìŠ¤íŠ¸ë¥¼ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'ì´ íšŒì›ì„ ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë¡œê·¸ì¸ ë¶ˆê°€)')) return;
            try {
                await updateDoc(doc(db, "users", uid), { blacklisted: !isBlacklisted });
                loadUsers();
            } catch(e) { alert(e.message); }
        };

        window.editPoints = async (uid, currentPoints) => {
            const newPoints = prompt("ìˆ˜ì •í•  í¬ì¸íŠ¸ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”:", currentPoints);
            if(newPoints === null) return;
            
            try {
                await updateDoc(doc(db, "users", uid), { points: parseInt(newPoints) });
                loadUsers();
            } catch(e) { alert(e.message); }
        };

        // --- 3. ê°•ì˜ ê´€ë¦¬ ---
        window.loadCourses = async () => {
            const list = document.getElementById('coursesList');
            const q = query(collection(db, "courses"), orderBy("createdAt", "desc"));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                list.innerHTML = '<p>ë“±ë¡ëœ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            let html = `
                <table class="table">
                    <thead><tr><th>ì œëª©</th><th>ê°€ê²©</th><th>ê´€ë¦¬</th></tr></thead>
                    <tbody>
            `;
            snapshot.forEach(doc => {
                const c = doc.data();
                html += `
                    <tr>
                        <td>${c.image} ${c.title}</td>
                        <td>${c.price.toLocaleString()}ì›</td>
                        <td>
                            <button class="btn btn-primary" style="padding:5px 10px; font-size:12px" onclick="editCourse('${doc.id}')">ìˆ˜ì •</button>
                            <button class="btn btn-secondary" style="padding:5px 10px; font-size:12px; background:var(--danger)" onclick="deleteCourse('${doc.id}')">ì‚­ì œ</button>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            list.innerHTML = html;
        };

        window.showCourseForm = (courseId = null) => {
            document.getElementById('courseModal').classList.add('active');
            // í¼ ë¦¬ì…‹ ë¡œì§ í•„ìš” (ìƒëµ)
        };
        
        window.closeCourseModal = () => document.getElementById('courseModal').classList.remove('active');

        // ê°•ì˜ ì €ì¥ ë¡œì§
        document.getElementById('courseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('courseId').value;
            const data = {
                title: document.getElementById('courseTitle').value,
                description: document.getElementById('courseDescription').value,
                price: parseInt(document.getElementById('coursePrice').value),
                category: document.getElementById('courseCategory').value,
                image: document.getElementById('courseImage').value || 'ğŸ“–',
                content: document.getElementById('courseContent').value,
                createdAt: new Date().toISOString()
            };

            try {
                if (id) {
                    await updateDoc(doc(db, "courses", id), data);
                } else {
                    await addDoc(collection(db, "courses"), data);
                }
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeCourseModal();
                loadCourses();
            } catch (err) {
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
            }
        });
        
        window.deleteCourse = async (id) => {
            if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await deleteDoc(doc(db, "courses", id));
                loadCourses();
            }
        };

        // ê°•ì˜ ìˆ˜ì • ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë¡œì§ (ê°„ì†Œí™”)
        window.editCourse = async (id) => {
            const d = await getDoc(doc(db, "courses", id));
            const c = d.data();
            document.getElementById('courseId').value = d.id;
            document.getElementById('courseTitle').value = c.title;
            document.getElementById('courseDescription').value = c.description;
            document.getElementById('coursePrice').value = c.price;
            document.getElementById('courseCategory').value = c.category;
            document.getElementById('courseImage').value = c.image;
            document.getElementById('courseContent').value = c.content;
            
            document.getElementById('courseModalTitle').textContent = 'ê°•ì˜ ìˆ˜ì •';
            document.getElementById('courseModal').classList.add('active');
        }

    </script>
    <style>
        .admin-nav { display: flex; flex-direction: column; gap: 5px; }
        .admin-nav .admin-tab { 
            text-align: left; 
            padding: 15px; 
            border-bottom: none; 
            border-radius: 8px; 
        }
        .admin-nav .admin-tab.active { 
            background: var(--light-gray); 
            color: var(--primary); 
            font-weight: bold;
        }
        .admin-nav .admin-tab:hover { background: #f9fafb; }
    </style>
</body>
</html>
