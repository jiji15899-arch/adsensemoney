<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì»¤ë®¤ë‹ˆí‹° - ga100</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="logo" onclick="window.location.href='index.html'" style="cursor:pointer">ga100</h1>
                <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
            </div>
        </div>
    </header>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>ga100</h2>
            <button class="close-sidebar" onclick="toggleSidebar()">âœ•</button>
        </div>
        <div class="sidebar-section">
            <button class="auth-btn" id="authBtn" onclick="handleAuth()">ë¡œê·¸ì¸</button>
        </div>
    </aside>

    <main class="main-content">
        <div class="container">
            <h2 style="margin-bottom: 30px;">ì»¤ë®¤ë‹ˆí‹°</h2>

            <div class="admin-tabs">
                <button class="admin-tab active" onclick="switchTab('notice')">ê³µì§€ì‚¬í•­</button>
                <button class="admin-tab" onclick="switchTab('secret')">ì‹œí¬ë¦¿ 1:1 ì§ˆë¬¸</button>
                <button class="admin-tab" onclick="switchTab('tips')">ì œì ë…¸í•˜ìš°</button>
                <button class="admin-tab" onclick="switchTab('free')">ììœ ê²Œì‹œíŒ</button>
                <button class="admin-tab" onclick="switchTab('qna')">ì§ˆë¬¸/ë‹µë³€</button>
            </div>

            <!-- Notice -->
            <div class="admin-content active" id="notice-content">
                <div style="margin-bottom: 20px;" id="noticeWriteBtn"></div>
                <div id="noticeList"><div style="text-align: center; padding: 40px; color: var(--gray);">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
            </div>

            <!-- Secret Questions -->
            <div class="admin-content" id="secret-content">
                <div style="margin-bottom: 20px;" id="secretWriteBtn"></div>
                <div id="secretList"><div style="text-align: center; padding: 40px; color: var(--gray);">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
            </div>

            <!-- Tips -->
            <div class="admin-content" id="tips-content">
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showPostForm('tips')" id="tipsBtn">ë…¸í•˜ìš° ì‘ì„±</button>
                </div>
                <div id="tipsList"><div style="text-align: center; padding: 40px; color: var(--gray);">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
            </div>

            <!-- Free Board -->
            <div class="admin-content" id="free-content">
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showPostForm('free')" id="freeBtn">ê¸€ ì‘ì„±</button>
                </div>
                <div id="freeList"><div style="text-align: center; padding: 40px; color: var(--gray);">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
            </div>

            <!-- QnA -->
            <div class="admin-content" id="qna-content">
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showPostForm('qna')" id="qnaBtn">ì§ˆë¬¸ ì‘ì„±</button>
                </div>
                <div id="qnaList"><div style="text-align: center; padding: 40px; color: var(--gray);">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
            </div>
        </div>
    </main>

    <!-- Post Form Modal -->
    <div class="modal" id="postModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">ê¸€ ì‘ì„±</h3>
                <button class="modal-close" onclick="closePostModal()">âœ•</button>
            </div>
            <form onsubmit="submitPost(event)">
                <div id="postAlert"></div>
                <div class="form-group">
                    <label>ì œëª©</label>
                    <input type="text" id="postTitle" required>
                </div>
                <div class="form-group">
                    <label>ë‚´ìš©</label>
                    <textarea id="postContent" required style="min-height: 200px;"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" id="postSubmitBtn">ë“±ë¡</button>
            </form>
        </div>
    </div>

    <!-- Post Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>ê²Œì‹œê¸€</h3>
                <button class="modal-close" onclick="closeDetailModal()">âœ•</button>
            </div>
            <div id="postDetail"></div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-links">
                <a href="my-home.html">ë§ˆì´í™ˆ</a>
                <a href="revenue.html">ìˆ˜ìµì¸ì¦</a>
                <a href="courses.html">ì „ìì±…</a>
                <a href="community.html">ì»¤ë®¤ë‹ˆí‹°</a>
            </div>
            <p class="copyright">Â© 2024 ga100. All rights reserved.</p>
        </div>
    </footer>

    <script type="module">
        import './firebase-config.js';

        let currentUser = null;
        let userData = null;
        let currentPostType = '';
        const urlParams = new URLSearchParams(window.location.search);
        const initialTab = urlParams.get('tab') || 'notice';

        document.addEventListener('DOMContentLoaded', async () => {
            await initAuth();
            await loadInitialTab();
        });

        async function initAuth() {
            const userSession = sessionStorage.getItem('currentUser');
            const authBtn = document.getElementById('authBtn');
            
            if (userSession) {
                currentUser = JSON.parse(userSession);
                userData = await window.firebaseDB.getUser(currentUser.nickname);
                authBtn.textContent = 'ë¡œê·¸ì•„ì›ƒ';
                authBtn.onclick = logout;
                initWriteButtons();
            } else {
                authBtn.textContent = 'ë¡œê·¸ì¸';
                authBtn.onclick = () => window.location.href = 'login.html';
                ['tipsBtn', 'freeBtn', 'qnaBtn'].forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.disabled = true;
                });
            }
        }

        function initWriteButtons() {
            // Notice write button (admin/manager only)
            if (userData && (userData.role === 'admin' || userData.role === 'manager')) {
                document.getElementById('noticeWriteBtn').innerHTML = '<button class="btn btn-primary" onclick="showPostForm(\'notice\')">ê³µì§€ ì‘ì„±</button>';
            }

            // Secret question button
            const secretQuestions = userData?.secretQuestions || 0;
            document.getElementById('secretWriteBtn').innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="showPostForm('secret')" ${secretQuestions === 0 ? 'disabled' : ''}>ì‹œí¬ë¦¿ ì§ˆë¬¸í•˜ê¸°</button>
                    <span style="color: var(--gray);">ë³´ìœ  ì§ˆë¬¸ê¶Œ: ${secretQuestions}ê°œ</span>
                </div>
            `;
        }

        async function loadInitialTab() {
            const tabButtons = ['notice', 'secret', 'tips', 'free', 'qna'];
            const tabIndex = tabButtons.indexOf(initialTab);
            
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-content').forEach(c => c.classList.remove('active'));
            
            if (tabIndex >= 0) {
                document.querySelectorAll('.admin-tab')[tabIndex].classList.add('active');
                document.getElementById(initialTab + '-content').classList.add('active');
            }

            for (const tab of tabButtons) {
                await loadPosts(tab);
            }
        }

        window.toggleSidebar = function() {
            document.getElementById('sidebar').classList.toggle('active');
        };

        window.handleAuth = function() {
            if (currentUser) {
                logout();
            } else {
                window.location.href = 'login.html';
            }
        };

        async function logout() {
            try {
                await window.firebaseAuth.signOut();
                sessionStorage.removeItem('currentUser');
                window.location.reload();
            } catch (error) {
                console.error('Logout error:', error);
                alert('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        window.switchTab = async function(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + '-content').classList.add('active');
        };

        window.showPostForm = function(type) {
            if (!currentUser) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'login.html';
                return;
            }

            if (type === 'notice' && userData.role !== 'admin' && userData.role !== 'manager') {
                alert('ê³µì§€ëŠ” ê´€ë¦¬ìë§Œ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            if (type === 'secret' && (userData.secretQuestions || 0) === 0) {
                alert('ì‹œí¬ë¦¿ ì§ˆë¬¸ê¶Œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            currentPostType = type;
            const titles = {
                'notice': 'ê³µì§€ ì‘ì„±',
                'secret': 'ì‹œí¬ë¦¿ ì§ˆë¬¸ ì‘ì„±',
                'tips': 'ë…¸í•˜ìš° ì‘ì„±',
                'free': 'ììœ ê²Œì‹œíŒ ê¸€ ì‘ì„±',
                'qna': 'ì§ˆë¬¸ ì‘ì„±'
            };
            document.getElementById('modalTitle').textContent = titles[type];
            document.getElementById('postModal').classList.add('active');
        };

        window.closePostModal = function() {
            document.getElementById('postModal').classList.remove('active');
            document.getElementById('postTitle').value = '';
            document.getElementById('postContent').value = '';
            document.getElementById('postAlert').innerHTML = '';
        };

        window.submitPost = async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();
            const alertDiv = document.getElementById('postAlert');
            const submitBtn = document.getElementById('postSubmitBtn');

            alertDiv.innerHTML = '';
            submitBtn.disabled = true;

            try {
                await window.firebaseDB.addPost({
                    type: currentPostType,
                    title: title,
                    content: content,
                    author: currentUser.nickname,
                    comments: []
                });

                // Deduct secret question if type is secret
                if (currentPostType === 'secret') {
                    await window.firebaseDB.updateUser(currentUser.nickname, {
                        secretQuestions: (userData.secretQuestions || 0) - 1
                    });
                    userData.secretQuestions = (userData.secretQuestions || 0) - 1;
                }

                // Add points for community posts
                if (currentPostType === 'tips' || currentPostType === 'free') {
                    await window.firebaseDB.updateUser(currentUser.nickname, {
                        secretQuestions: (userData.secretQuestions || 0) + 2
                    });
                    userData.secretQuestions = (userData.secretQuestions || 0) + 2;
                }

                alertDiv.innerHTML = '<div class="alert alert-success">ê²Œì‹œê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
                
                setTimeout(async () => {
                    closePostModal();
                    await loadPosts(currentPostType);
                    initWriteButtons();
                    submitBtn.disabled = false;
                }, 1500);
            } catch (error) {
                console.error('Error submitting post:', error);
                alertDiv.innerHTML = '<div class="alert alert-error">ê²Œì‹œê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                submitBtn.disabled = false;
            }
        };

        async function loadPosts(type) {
            try {
                const posts = await window.firebaseDB.getPosts(type);
                const listId = type + 'List';
                const list = document.getElementById(listId);

                if (posts.length === 0) {
                    list.innerHTML = '<p style="color: var(--gray); padding: 40px; text-align: center;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                list.innerHTML = posts.map(post => {
                    const postDate = post.createdAt?.toDate ? post.createdAt.toDate() : new Date();
                    return `
                        <div class="admin-panel" style="cursor: pointer; margin-bottom: 15px; transition: transform 0.2s;" onclick="showPostDetail('${post.id}')" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <h4 style="margin: 0; flex: 1;">${post.title}</h4>
                                <span style="color: var(--gray); font-size: 14px; white-space: nowrap; margin-left: 10px;">${postDate.toLocaleDateString('ko-KR')}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: var(--gray); font-size: 14px;">${post.author}</span>
                                <span style="color: var(--gray); font-size: 14px;">ğŸ’¬ ${(post.comments || []).length}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading posts:', error);
                document.getElementById(type + 'List').innerHTML = '<p style="color: var(--danger); padding: 20px; text-align: center;">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }

        window.showPostDetail = async function(postId) {
            try {
                const post = await window.firebaseDB.getPost(postId);
                if (!post) return;

                const postDate = post.createdAt?.toDate ? post.createdAt.toDate() : new Date();

                const detailHtml = `
                    <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border);">
                        <h3 style="margin-bottom: 10px;">${post.title}</h3>
                        <div style="display: flex; gap: 15px; color: var(--gray); font-size: 14px; margin-bottom: 15px;">
                            <span>${post.author}</span>
                            <span>${postDate.toLocaleString('ko-KR')}</span>
                        </div>
                        <p style="line-height: 1.8; white-space: pre-wrap;">${post.content}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px;">ëŒ“ê¸€ ${(post.comments || []).length}ê°œ</h4>
                        <div id="commentsList">
                            ${(post.comments || []).map(comment => `
                                <div style="background: var(--light-gray); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <strong>${comment.author}</strong>
                                        <span style="color: var(--gray); font-size: 12px;">${new Date(comment.createdAt).toLocaleString('ko-KR')}</span>
                                    </div>
                                    <p style="margin: 0; white-space: pre-wrap;">${comment.content}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    ${currentUser ? `
                        <form onsubmit="addComment(event, '${postId}')">
                            <div class="form-group">
                                <label>ëŒ“ê¸€ ì‘ì„±</label>
                                <textarea id="commentContent" required style="min-height: 80px;"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">ëŒ“ê¸€ ë“±ë¡</button>
                        </form>
                    ` : '<p style="color: var(--gray); text-align: center;">ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>'}
                `;

                document.getElementById('postDetail').innerHTML = detailHtml;
                document.getElementById('detailModal').classList.add('active');
            } catch (error) {
                console.error('Error showing post detail:', error);
                alert('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };

        window.closeDetailModal = function() {
            document.getElementById('detailModal').classList.remove('active');
        };

        window.addComment = async function(e, postId) {
            e.preventDefault();
            
            const content = document.getElementById('commentContent').value.trim();
            if (!content) return;

            try {
                await window.firebaseDB.addComment(postId, {
                    author: currentUser.nickname,
                    content: content
                });

                // Add secret question for comment
                await window.firebaseDB.updateUser(currentUser.nickname, {
                    secretQuestions: (userData.secretQuestions || 0) + 1
                });
                userData.secretQuestions = (userData.secretQuestions || 0) + 1;

                alert('ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ì‹œí¬ë¦¿ ì§ˆë¬¸ê¶Œ 1ê°œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.');
                
                // Reload post detail
                const post = await window.firebaseDB.getPost(postId);
                await showPostDetail(postId);
                
                // Reload posts list
                await loadPosts(post.type);
                initWriteButtons();
            } catch (error) {
                console.error('Error adding comment:', error);
                alert('ëŒ“ê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };
    </script>
</body>
    </html>
